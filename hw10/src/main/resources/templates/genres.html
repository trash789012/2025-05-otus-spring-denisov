<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>List of all genres</title>
    <style th:replace="~{fragments/menu :: menu-styles}"></style>
    <style th:replace="~{fragments/styles :: table-styles}"></style>
    <style th:replace="~{fragments/styles :: global-styles}"></style>
</head>
<body>

<!-- menu -->
<div class="nav-container">
    <div class="nav-menu" th:replace="~{fragments/menu :: main-menu}"></div>
</div>

<div class="content-container">
    <div class="table-header">
        <h2>List of genres</h2>
        <a th:href="@{/genre/new}" class="create-button-action">new</a>
    </div>

    <table class="genres">
        <thead>
        <tr>
            <th>Genre name</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="genres-table-body">
        <!--  insert from JS code -->
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        //грузим жанры
        loadGenres();

        function loadGenres() {
            fetch('/api/v1/genre')
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok!")
                    }
                    return response.json();
                })
                .then(genres => {
                    const tableBody = document.getElementById("genres-table-body");
                    tableBody.innerHTML = '';

                    genres.forEach(genre => {
                        const row = document.createElement('tr');

                        // Колонка с именем жанра
                        const nameCell = document.createElement('td');
                        const nameLink = document.createElement('a');
                        nameLink.href = `/genre/${genre.id}`;
                        nameLink.textContent = genre.name;
                        nameCell.appendChild(nameLink);

                        // Колонка с действиями
                        const actionCell = document.createElement('td');
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.className = 'btn-link';
                        deleteButton.onclick = () => {
                            deleteGenre(genre.id);
                        }
                        actionCell.appendChild(deleteButton);

                        row.appendChild(nameCell);
                        row.appendChild(actionCell);
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading genres', error);
                    alert('Failed to load genres')
                })
        }

        function deleteGenre(genreId) {
            if (!confirm('Are you sure you want to delete this genre?')) {
                return;
            }

            fetch(`/api/v1/genre/${genreId}`, {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        loadGenres(); // Обновляем список после удаления
                    } else {
                        throw new Error('Delete failed');
                    }
                })
                .catch(error => {
                    console.error('Error deleting genre:', error);
                    alert('Filed to delete genre');
                })
        }

    })
</script>

</body>
</html>
